{% extends "base.html" %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<style>
  :root{
    --grid-border: #e5e7eb;
    --row-even: #f9fafb;
    --row-odd: #ffffff;
    --row-hover: #eef2ff;
    --tag-bg: #e0f2fe;
    --tag-bd: #bae6fd;
    --tag-fg: #0f172a;
  }
  .yb-wrap{margin:10px 0 24px;}
  .yb-title{font-size:18px;font-weight:600;margin:6px 0 12px;}
  .yb-grid{border-collapse:separate;border-spacing:0;width:100%;table-layout:fixed;border:1px solid var(--grid-border);border-radius:12px;overflow:hidden}
  .yb-grid th,.yb-grid td{border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);padding:6px 8px;vertical-align:top}
  .yb-grid th:last-child,.yb-grid td:last-child{border-right:none}
  .yb-grid thead th{position:sticky;top:0;background:linear-gradient(180deg, #36c, #2563eb 60%, #1d4ed8);color:#fff;font-weight:600;font-size:12px;text-align:center;z-index:3}
  .yb-grid .row-title{position:sticky;left:0;background:#fff;font-weight:600;z-index:2;max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .yb-grid tbody tr:nth-child(odd){background:var(--row-odd)}
  .yb-grid tbody tr:nth-child(even){background:var(--row-even)}
  .yb-grid tbody tr:hover{background:var(--row-hover)}
  .cell{min-height:38px;font-size:12px;line-height:1.1}
  .tag{
    display:inline-block;margin:2px 4px 0 0;padding:4px 6px;border-radius:999px;
    background:var(--tag-bg); color:var(--tag-fg); border:1px solid var(--tag-bd);
    font-size:11px; text-decoration:none;
  }
  .tag:hover{filter:brightness(0.95)}
  /* Tooltip (her şeyin ÜSTÜNDE) */
  #ytip{
    position:fixed; top:0; left:0; pointer-events:none; transform:translate(-9999px,-9999px);
    z-index:10000; background:#fff; color:#0f172a; border:1px solid #cbd5e1; border-radius:10px;
    box-shadow:0 10px 25px rgba(2,6,23,.18); padding:10px 12px; font-size:13px; line-height:1.25; max-width:320px;
  }
  #ytip .t-title{font-weight:700;margin-bottom:6px;color:#0ea5e9}
  #ytip .t-row{margin:2px 0}
  #ytip .t-l{color:#64748b;margin-right:6px}
  .yb-scroll{overflow:auto}
</style>

<div class="yb-wrap">
  <div class="yb-title">{{ page_title }}</div>
  <div class="yb-scroll">
    <table class="yb-grid">
      <thead>
        <tr>
          <th class="row-title">Eğitim</th>
          {% for w in weeks %}
            <th>W{{ w }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr>
            <th class="row-title">{{ row.title|default:" " }}</th>
            {% for slot in row.week_plans %}
              <td class="cell">
                {% for p in slot %}
                  <a class="tag"
                     href="{{ p.admin_link }}"
                     target="_blank"
                     data-tip-title="{{ row.title|default:'(Boş satır)' }}"
                     data-tip-when="{{ p.when }}"
                     data-tip-trainer="{{ p.trainer }}"
                     data-tip-people="{{ p.attendees_txt }}">
                    #{{ p.id }}
                  </a>
                {% endfor %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div id="ytip" role="tooltip" aria-hidden="true">
  <div class="t-title"></div>
  <div class="t-row"><span class="t-l">Tarih:</span><span class="t-v" data-k="when"></span></div>
  <div class="t-row"><span class="t-l">Eğitmen:</span><span class="t-v" data-k="trainer"></span></div>
  <div class="t-row"><span class="t-l">Katılımcılar:</span><span class="t-v" data-k="people"></span></div>
</div>

<script>
(function(){
  const tip = document.getElementById('ytip');
  function showTip(el, ev){
    const title = el.getAttribute('data-tip-title') || '';
    const when = el.getAttribute('data-tip-when') || '-';
    const trainer = el.getAttribute('data-tip-trainer') || '-';
    const people = el.getAttribute('data-tip-people') || '-';

    tip.querySelector('.t-title').textContent = title;
    tip.querySelector('[data-k="when"]').textContent = when;
    tip.querySelector('[data-k="trainer"]').textContent = trainer;
    tip.querySelector('[data-k="people"]').textContent = people;

    const pad = 16;
    let x = ev.clientX + pad;
    let y = ev.clientY + pad;

    const vw = window.innerWidth, vh = window.innerHeight;
    const bb = tip.getBoundingClientRect();
    if (x + bb.width + 8 > vw) x = ev.clientX - bb.width - pad;
    if (y + bb.height + 8 > vh) y = ev.clientY - bb.height - pad;

    tip.style.transform = `translate(${x}px, ${y}px)`;
    tip.setAttribute('aria-hidden','false');
  }
  function hideTip(){
    tip.style.transform = 'translate(-9999px,-9999px)';
    tip.setAttribute('aria-hidden','true');
  }
  document.addEventListener('mouseover', function(e){
    const a = e.target.closest('a.tag');
    if(a){ showTip(a, e); }
  });
  document.addEventListener('mousemove', function(e){
    const a = e.target.closest('a.tag');
    if(a){ showTip(a, e); }
  });
  document.addEventListener('mouseout', function(e){
    if(!e.relatedTarget || !e.relatedTarget.closest || !e.relatedTarget.closest('#ytip')){
      hideTip();
    }
  });
})();
</script>
{% endblock %}
